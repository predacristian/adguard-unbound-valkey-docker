name: DNS Stack CI/CD (Optimized)

on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  merge_group:
    branches: [ main ]

concurrency:
  group: dns-stack-ci-cd-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  # Fast single-arch build for testing (amd64 only)
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      test_tag: ${{ steps.tag.outputs.tag }}
    steps:
    - uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Generate test tag
      id: tag
      run: |
        BRANCH_NAME=${GITHUB_REF##*/}
        CLEAN_BRANCH_NAME=$(echo $BRANCH_NAME | tr '/' '-')
        SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
        echo "tag=${CLEAN_BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_OUTPUT

    # Build ONLY amd64 for testing (much faster!)
    - name: Build test image (amd64 only)
      uses: docker/build-push-action@v6
      with:
        context: .
        load: true
        platforms: linux/amd64
        tags: dns-stack-test:${{ steps.tag.outputs.tag }}
        # Aggressive caching for faster builds
        cache-from: |
          type=gha,scope=main
          type=gha,scope=${{ github.ref_name }}
        cache-to: type=gha,mode=max,scope=${{ github.ref_name }}
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Start test container
      run: |
        sudo sysctl -w net.core.rmem_max=8388608
        sudo sysctl -w net.core.wmem_max=8388608
        docker run -d --name dns-stack-test \
          -v ${{ github.workspace }}/tests:/tests \
          dns-stack-test:${{ steps.tag.outputs.tag }}

    - name: Wait for services to be ready
      run: |
        echo "Waiting for services to initialize..."
        timeout=90
        elapsed=0
        interval=5
        container=dns-stack-test
        health=""
        while [ $elapsed -lt $timeout ]; do
          if docker inspect --format='{{.State.Health.Status}}' $container >/dev/null 2>&1; then
            health=$(docker inspect --format='{{.State.Health.Status}}' $container)
            if [ "$health" = "healthy" ]; then
              echo "Container is healthy"
              break
            fi
            echo "Waiting for container to be healthy... ($elapsed/$timeout seconds) status=$health"
          else
            echo "Container has no health status yet (elapsed=${elapsed}s)"
          fi
          sleep $interval
          elapsed=$((elapsed + interval))
        done
        if [ "$health" != "healthy" ]; then
          echo "Container failed to become healthy within $timeout seconds"
          docker inspect $container || true
          docker logs $container || true
          exit 1
        fi
        docker ps
        docker logs $container

    - name: Set permissions on test scripts
      run: |
        chmod +x ./tests/*.sh

    - name: Run smoke tests
      id: smoke_tests
      run: |
        echo "=== Running Smoke Tests ==="
        docker exec dns-stack-test /tests/test_architecture.sh
        docker exec dns-stack-test /tests/test_unbound.sh
        docker exec dns-stack-test /tests/test_valkey.sh
        docker exec dns-stack-test /tests/test_adguard.sh

    - name: Run integration tests
      id: integration_tests
      run: |
        echo "=== Running Integration Tests ==="
        docker exec dns-stack-test /tests/test_cache_integration.sh
        docker exec dns-stack-test /tests/test_e2e_query.sh
        docker exec dns-stack-test /tests/test_ad_blocking.sh
        docker exec dns-stack-test /tests/test_dot.sh || echo "DoT tests skipped (not configured)"

    - name: Run BATS integration tests
      id: bats_tests
      run: |
        echo "=== Running BATS Tests ==="
        docker exec dns-stack-test bats --formatter tap /tests/integration.bats

    - name: Run Trivy vulnerability scanner
      id: trivy_scan
      uses: aquasecurity/trivy-action@0.33.1
      continue-on-error: true
      with:
        image-ref: 'dns-stack-test:${{ steps.tag.outputs.tag }}'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always() && hashFiles('trivy-results.sarif') != ''
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@0.33.1
      continue-on-error: true
      with:
        image-ref: 'dns-stack-test:${{ steps.tag.outputs.tag }}'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'

    - name: Test Summary
      if: always()
      run: |
        echo "Test Results Summary:"
        echo "===================="
        echo "Smoke Tests: ${{ steps.smoke_tests.outcome }}"
        echo "Integration Tests: ${{ steps.integration_tests.outcome }}"
        echo "BATS Tests: ${{ steps.bats_tests.outcome }}"

    - name: Clean up
      if: always()
      run: |
        docker stop dns-stack-test || true
        docker rm dns-stack-test || true

  check-changes:
    needs: build-and-test
    runs-on: ubuntu-latest
    outputs:
      files_changed: ${{ steps.check_files.outputs.changed }}
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 2
    - name: Check for relevant file changes
      id: check_files
      run: |
        git diff --name-only HEAD^ HEAD > changed_files.txt
        echo "Changed files:"
        cat changed_files.txt
        if grep -qE '^(Dockerfile|config/|entrypoint\.sh)' changed_files.txt; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

  # Note: Docker image building and pushing is now handled by the release.yml workflow
  # This workflow focuses on testing PRs and validating changes
  # Versioned releases are automatically created when commits are pushed to main
